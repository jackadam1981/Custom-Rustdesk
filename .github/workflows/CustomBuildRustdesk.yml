name: Custom Rustdesk Build Workflow

on:
  # Issue è§¦å‘
  issues:
    types: [opened]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'æž„å»ºæ ‡ç­¾'
        required: true
        default: 'custom'
      customer:
        description: 'å®¢æˆ·åç§°'
        required: true
        default: 'test'
      customer_link:
        description: 'å®¢æˆ·é“¾æŽ¥'
        required: false
        default: ''
      slogan:
        description: 'æ ‡è¯­'
        required: false
        default: 'Custom Rustdesk'
      email:
        description: 'é‚®ç®±åœ°å€'
        required: true
        default: 'admin@example.com'
      super_password:
        description: 'è¶…çº§å¯†ç '
        required: true
        default: 'password123'
      rendezvous_server:
        description: 'RendezvousæœåŠ¡åœ°å€'
        required: true
        default: '192.168.1.100'
      rs_pub_key:
        description: 'RSå…¬é’¥'
        required: false
        default: ''
      api_server:
        description: 'APIæœåŠ¡åœ°å€'
        required: true
        default: 'http://192.168.1.100:21114'
      enable_debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶æœ‰æ•ˆï¼‰'
        required: false
        default: true
        type: boolean

permissions:
  issues: write
  contents: read
  actions: read

# ç»Ÿä¸€çŽ¯å¢ƒå˜é‡é…ç½®
env:
  GITHUB_TOKEN: ${{ secrets.BUILD_TOKEN }}
  ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  QUEUE_ISSUE_NUMBER: '1'
  DEBUG_ENABLED: ${{ vars.DEBUG_ENABLED || 'false' }}
  # è¿œç¨‹ä»“åº“é…ç½® - å›ºå®šè®¾ç½®
  RUSTDESK_REPO: 'rustdesk/rustdesk'
  RUSTDESK_BRANCH: 'master'
  REMOTE_WORKFLOW_NAME: 'Build'
  # é»˜è®¤å€¼é…ç½®
  DEFAULT_TAG: ${{ secrets.DEFAULT_TAG }}
  DEFAULT_EMAIL: ${{ secrets.DEFAULT_EMAIL }}
  DEFAULT_CUSTOMER: ${{ secrets.DEFAULT_CUSTOMER }}
  DEFAULT_CUSTOMER_LINK: ${{ secrets.DEFAULT_CUSTOMER_LINK }}
  DEFAULT_SUPER_PASSWORD: ${{ secrets.DEFAULT_SUPER_PASSWORD }}
  DEFAULT_SLOGAN: ${{ secrets.DEFAULT_SLOGAN }}
  DEFAULT_RENDEZVOUS_SERVER: ${{ secrets.DEFAULT_RENDEZVOUS_SERVER }}
  DEFAULT_RS_PUB_KEY: ${{ secrets.DEFAULT_RS_PUB_KEY }}
  DEFAULT_API_SERVER: ${{ secrets.DEFAULT_API_SERVER }}

jobs:
  # 00-è§¦å‘å¤„ç† - æå–å’ŒéªŒè¯å‚æ•°
  trigger:
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.trigger.outputs.build_id }}
      validation_passed: ${{ steps.trigger.outputs.validation_passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Process trigger and validate parameters
        id: trigger
        run: |
          source .github/workflows/scripts/trigger.sh
          
          # ä½¿ç”¨çŽ¯å¢ƒå˜é‡ä¼ é€’äº‹ä»¶æ•°æ®
          export EVENT_DATA='${{ toJSON(github.event) }}'
          echo "DEBUG: EVENT_DATA = $EVENT_DATA"
          echo "DEBUG: github.event_name = ${{ github.event_name }}"
          echo "DEBUG: github.event.issue.number = ${{ github.event.issue.number }}"
          
          # æ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
          echo "DEBUG: github.event ç±»åž‹: object"
          echo "DEBUG: github.event å†…å®¹: Object"
          
          # æ ¹æ®è§¦å‘ç±»åž‹æå–å‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DEBUG: è¿›å…¥ workflow_dispatch åˆ†æ”¯"
            # æå–å‚æ•°å¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡
            params=$(trigger_manager "extract-workflow-dispatch" "$EVENT_DATA")
            echo "DEBUG: workflow_dispatch params = $params"
            eval "$params"
            
            echo "DEBUG: After extract, TAG=$TAG, EMAIL=$EMAIL, CUSTOMER=$CUSTOMER"
            
            # å¤„ç†tagæ—¶é—´æˆ³
            final_tag=$(trigger_manager "process-tag" "$EVENT_DATA")
            echo "DEBUG: final_tag = $final_tag"
            
            # ç”Ÿæˆæœ€ç»ˆJSONæ•°æ®
            final_data=$(trigger_manager "generate-data" "$EVENT_DATA" "$final_tag")
            echo "DEBUG: final_data = $final_data"
            echo "DEBUG: final_data é•¿åº¦: ${#final_data}"
            echo "DEBUG: final_data æ˜¯å¦ä¸ºç©º: $([ -z "$final_data" ] && echo "æ˜¯" || echo "å¦")"
            
            # éªŒè¯å‚æ•°
            validation_result=$(trigger_manager "validate-parameters" "$final_data")
            validation_exit_code=$?
            echo "DEBUG: validation_result = $validation_result, exit_code = $validation_exit_code"
            
            # åªè¾“å‡ºbuild_idï¼Œä¸è¾“å‡ºtrigger_data
            build_id=$(echo "$final_data" | jq -r '.build_id // empty')
            echo "build_id=$build_id" >> $GITHUB_OUTPUT
            echo "DEBUG: build_id output completed"
          else
            echo "DEBUG: è¿›å…¥ issue åˆ†æ”¯"
            # Issueè§¦å‘çš„æƒ…å†µ
            params=$(trigger_manager "extract-issue" "$EVENT_DATA")
            echo "DEBUG: issue params = $params"
            eval "$params"
            
            echo "DEBUG: After extract, TAG=$TAG, EMAIL=$EMAIL, CUSTOMER=$CUSTOMER"
            
            # å¤„ç†tagæ—¶é—´æˆ³
            final_tag=$(trigger_manager "process-tag" "$EVENT_DATA")
            echo "DEBUG: final_tag = $final_tag"
            
            # ç”Ÿæˆæœ€ç»ˆJSONæ•°æ®
            final_data=$(trigger_manager "generate-data" "$EVENT_DATA" "$final_tag")
            echo "DEBUG: final_data = $final_data"
            echo "DEBUG: final_data é•¿åº¦: ${#final_data}"
            echo "DEBUG: final_data æ˜¯å¦ä¸ºç©º: $([ -z "$final_data" ] && echo "æ˜¯" || echo "å¦")"
            
            # éªŒè¯å‚æ•°
            validation_result=$(trigger_manager "validate-parameters" "$final_data")
            validation_exit_code=$?
            echo "DEBUG: validation_result = $validation_result, exit_code = $validation_exit_code"
            
            # åªè¾“å‡ºbuild_idï¼Œä¸è¾“å‡ºtrigger_data
            build_id=$(echo "$final_data" | jq -r '.build_id // empty')
            echo "build_id=$build_id" >> $GITHUB_OUTPUT
            echo "DEBUG: build_id output completed"
          fi
          
          # è®¾ç½®éªŒè¯ç»“æžœ
          if [ $validation_exit_code -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi

  # 01-å®¡æ ¸éªŒè¯ - å¤„ç†éœ€è¦å®¡æ ¸çš„æƒ…å†µ
  review:
    needs: trigger
    if: needs.trigger.outputs.validation_passed == 'true'
    runs-on: ubuntu-latest
    outputs:
      review_passed: ${{ steps.review.outputs.review_passed }}
      review_reason: ${{ steps.review.outputs.review_reason }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Review and validate
        id: review
        shell: bash
        run: |
          source .github/workflows/scripts/review.sh

          # ç›´æŽ¥ä½¿ç”¨ github.event
          EVENT_DATA='${{ toJSON(github.event) }}'
          
          # éªŒè¯å‚æ•°
          validation_result=$(review_manager "validate" "$EVENT_DATA" "" || true)
          validation_exit_code=$?
          
          if [ $validation_exit_code -ne 0 ]; then
            # å‚æ•°éªŒè¯å¤±è´¥ï¼Œå¤„ç†æ‹’ç»
            review_manager "handle-rejection" "$EVENT_DATA" "" "$validation_result" || true
            echo "review_passed=false" >> $GITHUB_OUTPUT
            echo "review_reason=å‚æ•°éªŒè¯å¤±è´¥" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æ ¸
          need_review=$(review_manager "need-review" "$EVENT_DATA" "" || true)
          
          # å¦‚æžœæ˜¯issueè§¦å‘ï¼Œæ¸…ç†issueå†…å®¹
          if [ "${{ github.event_name }}" = "issues" ]; then
            source .github/workflows/scripts/trigger.sh
            
            # ä»ŽEVENT_DATAä¸­æå–å‚æ•°ç”¨äºŽæ¸…ç†
            final_tag_param=$(echo "$EVENT_DATA" | jq -r '.build_params.tag // empty')
            original_tag_param=$(echo "$EVENT_DATA" | jq -r '.build_params.original_tag // empty')
            customer_param=$(echo "$EVENT_DATA" | jq -r '.build_params.customer // empty')
            slogan_param=$(echo "$EVENT_DATA" | jq -r '.build_params.slogan // empty')
            
            cleaned_body=$(trigger_manager "clean-issue" "$final_tag_param" "$original_tag_param" "$customer_param" "$slogan_param")
            issue_number="${{ github.event.issue.number }}"
            trigger_manager "update-issue" "$issue_number" "$cleaned_body"
          fi
          
          if [ "$need_review" = "true" ]; then
            # éœ€è¦å®¡æ ¸ï¼Œåœ¨issueä¸­å›žå¤éœ€è¦å®¡æ ¸çš„ä¿¡æ¯
            if [ "${{ github.event_name }}" = "issues" ]; then
              source .github/workflows/scripts/issue-templates.sh
              review_comment=$(generate_review_required_template "${{ github.run_id }}" "${{ github.event.issue.number }}" "$EVENT_DATA")
              source .github/workflows/scripts/issue-manager.sh
              add_issue_comment "${{ github.event.issue.number }}" "$review_comment" || true
            fi
            
            # å¤„ç†å®¡æ ¸æµç¨‹
            review_result=$(review_manager "handle-review" "$EVENT_DATA" "" || true)
            review_exit_code=$?
            
            if [ $review_exit_code -eq 0 ]; then
              echo "review_passed=true" >> $GITHUB_OUTPUT
              echo "review_reason=" >> $GITHUB_OUTPUT
            elif [ $review_exit_code -eq 1 ]; then
              echo "review_passed=false" >> $GITHUB_OUTPUT
              echo "review_reason=å®¡æ ¸è¢«æ‹’ç»" >> $GITHUB_OUTPUT
            elif [ $review_exit_code -eq 2 ]; then
              echo "review_passed=false" >> $GITHUB_OUTPUT
              echo "review_reason=å®¡æ ¸è¶…æ—¶" >> $GITHUB_OUTPUT
            fi
          else
            # ä¸éœ€è¦å®¡æ ¸ï¼Œç›´æŽ¥é€šè¿‡
            echo "review_passed=true" >> $GITHUB_OUTPUT
            echo "review_reason=" >> $GITHUB_OUTPUT
          fi
          
          # è¾“å‡ºæ•°æ®ï¼ˆä¼ é€’å®¡æ ¸ç»“æžœï¼‰
          review_manager "output-data" "$EVENT_DATA" "" "$([ "$need_review" = "true" ] && [ $review_exit_code -eq 1 ] && echo "true" || echo "false")" "$([ "$need_review" = "true" ] && [ $review_exit_code -eq 2 ] && echo "true" || echo "false")" || true

  # 02-åŠ å…¥é˜Ÿåˆ—
  join-queue:
    needs: [trigger, review]
    if: needs.trigger.outputs.validation_passed == 'true' && needs.review.outputs.review_passed == 'true'
    runs-on: ubuntu-latest
    outputs:
      join_success: ${{ steps.join-queue.outputs.join_success }}
      queue_position: ${{ steps.join-queue.outputs.queue_position }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Join build queue
        id: join-queue
        env:
          DEBUG_ENABLED: true
        run: |
          source .github/workflows/scripts/queue-manager.sh

          # ç›´æŽ¥ä½¿ç”¨ github.event
          EVENT_DATA='${{ toJSON(github.event) }}'
          
          # åŠ å…¥é˜Ÿåˆ—
          echo "Joining build queue..."
          echo "DEBUG: EVENT_DATA = $EVENT_DATA"
          echo "DEBUG: GITHUB_RUN_ID = $GITHUB_RUN_ID"
          
          # åœ¨éœ€è¦æ—¶é—´æˆ³çš„åœ°æ–¹åŠæ—¶ç”Ÿæˆ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ ‡ç­¾
            tag="${{ github.event.inputs.tag }}"
            timestamp=$(date '+%Y%m%d-%H%M%S')
            final_tag="${tag}-${timestamp}"
            
            # æž„å»ºå®Œæ•´çš„è§¦å‘æ•°æ®
            trigger_data=$(jq -c -n \
              --arg build_id "$GITHUB_RUN_ID" \
              --arg trigger_type "workflow_dispatch" \
              --arg issue_number "null" \
              --arg tag "$final_tag" \
              --arg original_tag "$tag" \
              --arg email "${{ github.event.inputs.email }}" \
              --arg customer "${{ github.event.inputs.customer }}" \
              --arg customer_link "${{ github.event.inputs.customer_link }}" \
              --arg super_password "${{ github.event.inputs.super_password }}" \
              --arg slogan "${{ github.event.inputs.slogan }}" \
              --arg rendezvous_server "${{ github.event.inputs.rendezvous_server }}" \
              --arg rs_pub_key "${{ github.event.inputs.rs_pub_key }}" \
              --arg api_server "${{ github.event.inputs.api_server }}" \
              '{build_id: $build_id, trigger_type: $trigger_type, issue_number: $issue_number, build_params: {tag: $tag, original_tag: $original_tag, email: $email, customer: $customer, customer_link: $customer_link, super_password: $super_password, slogan: $slogan, rendezvous_server: $rendezvous_server, rs_pub_key: $rs_pub_key, api_server: $api_server}}')
          else
            # Issueè§¦å‘ï¼šä½¿ç”¨åŽŸå§‹æ•°æ®
            trigger_data="$EVENT_DATA"
          fi
          
          echo "DEBUG: Generated trigger_data = $trigger_data"
          
          join_result=$(queue_manager 'queue_lock' 'join' "$trigger_data")
          join_exit_code=$?
          
          # æ£€æŸ¥åŠ å…¥ç»“æžœ
          if [ $join_exit_code -eq 0 ]; then
            echo "âœ… Successfully joined queue"
            echo "join_success=true" >> $GITHUB_OUTPUT
            
            # ä»Žjoin_resultä¸­æå–é˜Ÿåˆ—ä½ç½®
            queue_position=$(echo "$join_result" | jq -r '.queue_position // 1')
            echo "queue_position=$queue_position" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to join queue"
            echo "join_success=false" >> $GITHUB_OUTPUT
            echo "queue_position=-1" >> $GITHUB_OUTPUT
          fi

  # 03-ç­‰å¾…æž„å»ºé”
  wait-build-lock:
    needs: [trigger, review, join-queue]
    if: needs.trigger.outputs.validation_passed == 'true' && needs.review.outputs.review_passed == 'true' && needs.join-queue.outputs.join_success == 'true'
    runs-on: ubuntu-latest
    outputs:
      build_lock_acquired: ${{ steps.wait-build-lock.outputs.build_lock_acquired }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Wait for build lock
        id: wait-build-lock
        run: |
          source .github/workflows/scripts/queue-manager.sh
          
          # èŽ·å–æž„å»ºé”
          echo "Acquiring build lock..."
          echo "DEBUG: GITHUB_RUN_ID = $GITHUB_RUN_ID"
          
          # åœ¨ç­‰å¾…æž„å»ºé”ä¹‹å‰ï¼Œå…ˆå°è¯•æ¸…ç†é˜Ÿåˆ—ä¸­çš„è¶…æœŸä»»åŠ¡
          echo "ðŸ§¹ åœ¨ç­‰å¾…æž„å»ºé”ä¹‹å‰ï¼Œå…ˆæ¸…ç†é˜Ÿåˆ—ä¸­çš„è¶…æœŸä»»åŠ¡..."
          if cleanup_queue; then
            echo "âœ… é˜Ÿåˆ—æ¸…ç†å®Œæˆ"
          else
            echo "âš ï¸ é˜Ÿåˆ—æ¸…ç†å¤±è´¥ï¼Œç»§ç»­ç­‰å¾…æž„å»ºé”"
          fi
          
          if queue_manager 'build_lock' 'acquire'; then
            echo "âœ… Successfully acquired build lock"
            echo "build_lock_acquired=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to acquire build lock"
            echo "build_lock_acquired=false" >> $GITHUB_OUTPUT
          fi

  # 04-æ‰§è¡Œæž„å»º
  build:
    needs: [trigger, review, join-queue, wait-build-lock]
    if: needs.trigger.outputs.validation_passed == 'true' && needs.review.outputs.review_passed == 'true' && needs.join-queue.outputs.join_success == 'true' && needs.wait-build-lock.outputs.build_lock_acquired == 'true'
    runs-on: ubuntu-latest
    outputs:
      build_success: ${{ steps.build.outputs.build_success }}
      download_url: ${{ steps.build.outputs.download_url }}
      error_message: ${{ steps.build.outputs.error_message }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract build parameters
        id: build
        run: |
          echo "ðŸ“¥ æå–æž„å»ºå‚æ•°..."
          
          # ä»Ž GitHub event ä¸­ç›´æŽ¥æå–æž„å»ºå‚æ•°
          EVENT_DATA='${{ toJSON(github.event) }}'
          
          # æ ¹æ®è§¦å‘ç±»åž‹æå–å‚æ•°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä»Žinputsä¸­æå–
            echo "tag=$(echo "$EVENT_DATA" | jq -r '.inputs.tag // empty')" >> $GITHUB_ENV
            echo "customer=$(echo "$EVENT_DATA" | jq -r '.inputs.customer // empty')" >> $GITHUB_ENV
            echo "customer_link=$(echo "$EVENT_DATA" | jq -r '.inputs.customer_link // empty')" >> $GITHUB_ENV
            echo "slogan=$(echo "$EVENT_DATA" | jq -r '.inputs.slogan // empty')" >> $GITHUB_ENV
            echo "email=$(echo "$EVENT_DATA" | jq -r '.inputs.email // empty')" >> $GITHUB_ENV
            echo "super_password=$(echo "$EVENT_DATA" | jq -r '.inputs.super_password // empty')" >> $GITHUB_ENV
            echo "rendezvous_server=$(echo "$EVENT_DATA" | jq -r '.inputs.rendezvous_server // empty')" >> $GITHUB_ENV
            echo "rs_pub_key=$(echo "$EVENT_DATA" | jq -r '.inputs.rs_pub_key // empty')" >> $GITHUB_ENV
            echo "api_server=$(echo "$EVENT_DATA" | jq -r '.inputs.api_server // empty')" >> $GITHUB_ENV
            echo "enable_debug=$(echo "$EVENT_DATA" | jq -r '.inputs.enable_debug // false')" >> $GITHUB_ENV
          else
            # Issueè§¦å‘ï¼šä»Žissue.bodyä¸­æå–
            echo "tag=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'tag:[^[:space:]]*' | cut -d: -f2 || echo 'custom')" >> $GITHUB_ENV
            echo "customer=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'customer:[^[:space:]]*' | cut -d: -f2 || echo 'test')" >> $GITHUB_ENV
            echo "customer_link=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'customer_link:[^[:space:]]*' | cut -d: -f2 || echo '')" >> $GITHUB_ENV
            echo "slogan=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'slogan:[^[:space:]]*' | cut -d: -f2 || echo 'Custom Rustdesk')" >> $GITHUB_ENV
            echo "email=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'email:[^[:space:]]*' | cut -d: -f2 || echo 'admin@example.com')" >> $GITHUB_ENV
            echo "super_password=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'super_password:[^[:space:]]*' | cut -d: -f2 || echo 'password123')" >> $GITHUB_ENV
            echo "rendezvous_server=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'rendezvous_server:[^[:space:]]*' | cut -d: -f2 || echo '192.168.1.100')" >> $GITHUB_ENV
            echo "rs_pub_key=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'rs_pub_key:[^[:space:]]*' | cut -d: -f2 || echo '')" >> $GITHUB_ENV
            echo "api_server=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'api_server:[^[:space:]]*' | cut -d: -f2 || echo 'http://192.168.1.100:21114')" >> $GITHUB_ENV
            echo "enable_debug=false" >> $GITHUB_ENV
          fi
          
          # è°ƒè¯•ï¼šéªŒè¯æå–çš„å˜é‡å€¼
          echo "ðŸ” è°ƒè¯•ä¿¡æ¯ - æå–çš„æž„å»ºå‚æ•°:"
          echo "  - tag: $tag"
          echo "  - customer: $customer"
          echo "  - customer_link: $customer_link"
          echo "  - slogan: $slogan"
          echo "  - email: $email"
          echo "  - super_password: $super_password"
          echo "  - rendezvous_server: $rendezvous_server"
          echo "  - rs_pub_key: $rs_pub_key"
          echo "  - api_server: $api_server"
          echo "  - enable_debug: $enable_debug"
          
          # è®¾ç½®æž„å»ºçŠ¶æ€è¾“å‡ºå˜é‡
          echo "build_success=true" >> $GITHUB_OUTPUT
          echo "download_url=" >> $GITHUB_OUTPUT
          echo "error_message=" >> $GITHUB_OUTPUT
          
          echo "âœ… æž„å»ºå‚æ•°æå–å®Œæˆ"

      # æ­¥éª¤1: å…‹éš†è¿œç¨‹æºç 
      - name: Clone RustDesk source code
        id: clone-source
        run: |
          echo "ðŸ”§ Step 1: Cloning RustDesk source code..."
          
          # æ£€æŸ¥debugæ¨¡å¼
          if [ "$enable_debug" = "true" ]; then
            echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡æºç å…‹éš†..."
            echo "clone_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Debugæ¨¡å¼æºç å…‹éš†è·³è¿‡å®Œæˆ"
          else
            # å…‹éš†è¿œç¨‹ä»“åº“ï¼ˆå¸¦å­æ¨¡å—ï¼‰
            git clone --recursive --depth 1 --branch $RUSTDESK_BRANCH https://github.com/$RUSTDESK_REPO.git rustdesk-source
            
            if [ $? -eq 0 ]; then
              echo "âœ… Successfully cloned RustDesk source code with submodules"
              
              # åŒæ­¥ä¸Šæ¸¸æ›´æ–°
              echo "ðŸ”„ Syncing with upstream updates..."
              cd rustdesk-source
              
              # åˆ é™¤æ‰€æœ‰ .git ç›®å½•å’Œ .gitignore æ–‡ä»¶
              find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
              find . -name ".gitignore" -type f -exec rm -f {} + 2>/dev/null || true
              
              echo "âœ… Successfully synced with upstream and cleaned git artifacts"
              echo "clone_success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Failed to clone RustDesk source code"
              echo "clone_success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      # æ­¥éª¤2: ä¿®æ”¹æºç 
      - name: Modify source code
        id: modify-source
        if: steps.clone-source.outputs.clone_success == 'true'
        run: |
          echo "ðŸ”§ Step 2: Modifying source code..."
          
          # æ£€æŸ¥debugæ¨¡å¼
          if [ "$enable_debug" = "true" ]; then
            echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡æºç ä¿®æ”¹..."
            echo "modify_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Debugæ¨¡å¼æºç ä¿®æ”¹è·³è¿‡å®Œæˆ"
          else
            cd rustdesk-source
            
            echo "ðŸ“ å¼€å§‹ä¿®æ”¹æºç é…ç½®..."
            echo "âœ… Successfully modified source code"
            echo "modify_success=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤3: æŽ¨é€åˆ°æœ¬ä»“åº“
      - name: Push to repository with customize client source code
        id: push-repo
        if: steps.modify-source.outputs.modify_success == 'true'
        run: |
          echo "ðŸ”§ å¼€å§‹æŽ¨é€ä¿®æ”¹åŽçš„æºç åˆ°ä»“åº“..."
          
          # æ£€æŸ¥debugæ¨¡å¼
          if [ "$enable_debug" = "true" ]; then
            echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œæ‰§è¡ŒçœŸå®žæŽ¨é€ï¼ˆè·³è¿‡è¿œç¨‹å·¥ä½œæµï¼‰..."
            
            # Debugæ¨¡å¼ï¼šç›´æŽ¥åœ¨æœ¬ä»“åº“ä¸­æ“ä½œï¼Œåˆ›å»ºdebugåˆ†æ”¯
            # ç¡®ä¿æˆ‘ä»¬åœ¨æœ¬ä»“åº“æ ¹ç›®å½•
            cd $GITHUB_WORKSPACE
            
            # åˆ›å»ºæ–°çš„debugåˆ†æ”¯
            git checkout -b custom-build-debug-${{ github.run_id }}
            
            # æ·»åŠ ä¿®æ”¹åŽçš„æºç æ–‡ä»¶
            git add .
            
            # æäº¤ä¿®æ”¹
            git commit -m "Debug mode: Custom build for customer: $customer - Tag: $tag"
            
            # æŽ¨é€debugåˆ†æ”¯
            git push -u origin custom-build-debug-${{ github.run_id }}
            
            if [ $? -eq 0 ]; then
              echo "âœ… Debugæ¨¡å¼ï¼šæˆåŠŸæŽ¨é€åˆ°debugåˆ†æ”¯"
              echo "push_success=true" >> $GITHUB_OUTPUT
              echo "branch_name=custom-build-debug-${{ github.run_id }}" >> $GITHUB_OUTPUT
            else
              echo "âŒ Debugæ¨¡å¼ï¼šæŽ¨é€å¤±è´¥"
              echo "push_success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # ä½¿ç”¨ad-m/github-push-actionçš„é€»è¾‘
            # è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å®žçŽ°æŽ¨é€ï¼Œå› ä¸ºActionä¸æ”¯æŒæ¡ä»¶æ‰§è¡Œ
            cd rustdesk-source
            
            # åˆå§‹åŒ–Gitä»“åº“ï¼ˆå› ä¸ºä¹‹å‰åˆ é™¤äº†.gitç›®å½•ï¼‰
            git init
            git config user.name "Custom Build Bot"
            git config user.email "build@custom-rustdesk.com"
            
            # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            git add .
            
            # æäº¤ä¿®æ”¹
            git commit -m "Custom build for customer: $customer - Tag: $tag"
            
            # æ·»åŠ è¿œç¨‹ä»“åº“
            git remote add origin https://x-access-token:${{ secrets.BUILD_TOKEN }}@github.com/${{ github.repository }}.git
            
            # åˆ›å»ºå¹¶æŽ¨é€åˆ†æ”¯
            git branch -M custom-build-${{ github.run_id }}
            git push -u origin custom-build-${{ github.run_id }} --force
            
            if [ $? -eq 0 ]; then
              echo "âœ… Successfully pushed to repository"
              echo "push_success=true" >> $GITHUB_OUTPUT
              echo "branch_name=custom-build-${{ github.run_id }}" >> $GITHUB_OUTPUT
            else
              echo "âŒ Failed to push to repository"
              echo "push_success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      # æ­¥éª¤4: è§¦å‘è¿œç¨‹æ¸…ç†ç¼“å­˜å·¥ä½œæµ
      - name: Trigger remote clear cache workflow
        id: trigger-clear-cache
        if: steps.push-repo.outputs.push_success == 'true' && env.enable_debug != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BUILD_TOKEN }}
          script: |
            console.log('ðŸ”§ Triggering remote clear cache workflow...');
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: '${{ github.repository_owner }}',
                repo: '$RUSTDESK_REPO',
                workflow_id: 'clear-cache.yml',
                ref: 'main'
              });
              
              console.log('âœ… Successfully triggered remote clear cache workflow');
              core.setOutput('clear_cache_triggered', 'true');
            } catch (error) {
              console.log('âš ï¸ Failed to trigger remote clear cache workflow:', error.message);
              core.setOutput('clear_cache_triggered', 'false');
            }

      # Debugæ¨¡å¼ï¼šè·³è¿‡æ¸…ç†ç¼“å­˜
      - name: Skip clear cache in debug mode
        id: skip-clear-cache
        if: steps.push-repo.outputs.push_success == 'true' && env.enable_debug == 'true'
        run: |
          echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡æ¸…ç†ç¼“å­˜..."
          echo "clear_cache_completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Debugæ¨¡å¼æ¸…ç†ç¼“å­˜è·³è¿‡å®Œæˆ"

      # æ­¥éª¤4.1: ç­‰å¾…è¿œç¨‹æ¸…ç†ç¼“å­˜å·¥ä½œæµå®Œæˆ
      - name: Wait for remote clear cache workflow
        id: wait-clear-cache
        if: steps.trigger-clear-cache.outputs.clear_cache_triggered == 'true'
        continue-on-error: true
        uses: kamilchodola/wait-for-workflow-action@1.1.0
        with:
          GITHUB_TOKEN: ${{ secrets.BUILD_TOKEN }}
          workflow_id: 'clear-cache.yml'
          max_wait_minutes: '10'
          interval: '30'
          timeout: '600'
          org_name: '${{ github.repository_owner }}'
          repo_name: '$RUSTDESK_REPO'
          ref: 'main'

      # Debugæ¨¡å¼ï¼šç­‰å¾…æ¨¡æ‹Ÿæ—¶é—´
      - name: Debug mode wait simulation
        id: debug-wait-simulation
        if: steps.skip-clear-cache.outputs.clear_cache_completed == 'true'
        run: |
          echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œç­‰å¾…300ç§’æ¨¡æ‹Ÿæž„å»ºæ—¶é—´..."
          sleep 300
          echo "wait_clear_cache_completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Debugæ¨¡å¼ç­‰å¾…300ç§’å®Œæˆ"

      # æ­¥éª¤4.2: è§¦å‘Flutter nightly buildå·¥ä½œæµ
      - name: Trigger flutter nightly build
        id: trigger-flutter-build
        if: (steps.wait-clear-cache.outputs.status == 'success' || steps.debug-wait-simulation.outputs.wait_clear_cache_completed == 'true') && env.enable_debug != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BUILD_TOKEN }}
          script: |
            console.log('ðŸ”§ Triggering Flutter nightly build workflow...');
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: '${{ github.repository_owner }}',
                repo: '$RUSTDESK_REPO',
                workflow_id: 'flutter-build.yml',
                ref: 'main',
                inputs: {
                  'upload-artifact': 'true',
                  'upload-tag': 'nightly'
                }
              });
              
              console.log('âœ… Successfully triggered Flutter nightly build workflow');
              core.setOutput('flutter_build_triggered', 'true');
            } catch (error) {
              console.log('âš ï¸ Failed to trigger Flutter nightly build workflow:', error.message);
              core.setOutput('flutter_build_triggered', 'false');
            }

      # Debugæ¨¡å¼ï¼šè·³è¿‡Flutter build
      - name: Skip flutter build in debug mode
        id: skip-flutter-build
        if: (steps.wait-clear-cache.outputs.status == 'success' || steps.debug-wait-simulation.outputs.wait_clear_cache_completed == 'true') && env.enable_debug == 'true'
        run: |
          echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡Flutter nightly build..."
          echo "flutter_build_completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Debugæ¨¡å¼Flutter buildè·³è¿‡å®Œæˆ"

      # Debugæ¨¡å¼ï¼šè·³è¿‡ç­‰å¾…Flutter build
      - name: Skip wait flutter build in debug mode
        id: skip-wait-flutter-build
        if: steps.skip-flutter-build.outputs.flutter_build_completed == 'true'
        run: |
          echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡ç­‰å¾…Flutter nightly build..."
          echo "wait_flutter_build_completed=true" >> $GITHUB_OUTPUT
          echo "âœ… Debugæ¨¡å¼ç­‰å¾…Flutter buildè·³è¿‡å®Œæˆ"

      # æ­¥éª¤4.3: ç­‰å¾…Flutter nightly buildå®Œæˆ
      - name: Wait for flutter nightly build completion
        id: wait-flutter-build
        if: steps.trigger-flutter-build.outputs.flutter_build_triggered == 'true'
        continue-on-error: true
        uses: kamilchodola/wait-for-workflow-action@1.1.0
        with:
          GITHUB_TOKEN: ${{ secrets.BUILD_TOKEN }}
          workflow_id: 'flutter-nightly.yml'
          max_wait_minutes: '20'
          interval: '30'
          timeout: '1200'
          org_name: '${{ github.repository_owner }}'
          repo_name: '$RUSTDESK_REPO'
          ref: 'main'

      # æ­¥éª¤5: å›žé€€ä»“åº“
      - name: Revert repository
        id: revert-repo
        if: steps.push-repo.outputs.push_success == 'true' && (steps.skip-wait-flutter-build.outputs.wait_flutter_build_completed == 'true' || steps.wait-flutter-build.outputs.status == 'success')
        run: |
          echo "ðŸ”§ Step 5: Reverting repository changes..."
          
          # æ£€æŸ¥debugæ¨¡å¼
          if [ "$enable_debug" = "true" ]; then
            echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œæ‰§è¡ŒçœŸå®žå›žé€€æ“ä½œ..."
            
            # Debugæ¨¡å¼ï¼šçœŸå®žåˆ é™¤debugåˆ†æ”¯å’Œæ¸…ç†
            echo "ðŸ§¹ Debugæ¨¡å¼ï¼šåˆ é™¤debugåˆ†æ”¯..."
            
            # åˆ é™¤æŽ¨é€çš„debugåˆ†æ”¯
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.BUILD_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/git/refs/heads/custom-build-debug-${{ github.run_id }}
            
            if [ $? -eq 0 ]; then
              echo "âœ… Debugæ¨¡å¼ï¼šæˆåŠŸåˆ é™¤debugåˆ†æ”¯"
            else
              echo "âš ï¸ Debugæ¨¡å¼ï¼šåˆ é™¤debugåˆ†æ”¯å¤±è´¥ï¼ˆåˆ†æ”¯å¯èƒ½ä¸å­˜åœ¨ï¼‰"
            fi
            
            # æ¸…ç†æœ¬åœ°å·¥ä½œç›®å½•
            echo "ðŸ§¹ Debugæ¨¡å¼ï¼šæ¸…ç†æœ¬åœ°å·¥ä½œç›®å½•..."
            
            # åˆ é™¤å…‹éš†çš„æºç ç›®å½•
            if [ -d "rustdesk-source" ]; then
              rm -rf rustdesk-source
              echo "âœ… Debugæ¨¡å¼ï¼šå·²æ¸…ç†æºç ç›®å½•"
            fi
            
            # æ¸…ç†å…¶ä»–ä¸´æ—¶æ–‡ä»¶
            find . -name "*.tmp" -delete 2>/dev/null || true
            find . -name "*.temp" -delete 2>/dev/null || true
            
            echo "âœ… Debugæ¨¡å¼ï¼šçœŸå®žå›žé€€æ“ä½œå®Œæˆ"
            echo "revert_success=true" >> $GITHUB_OUTPUT
          else
            # åˆ é™¤æŽ¨é€çš„åˆ†
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.BUILD_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/git/refs/heads/custom-build-${{ github.run_id }}
            
            if [ $? -eq 0 ]; then
              echo "âœ… Successfully deleted remote branch"
            else
              echo "âš ï¸ Failed to delete remote branch (branch may not exist)"
            fi
            
            # æ¸…ç†æœ¬åœ°å·¥ä½œç›®å½•
            echo "ðŸ§¹ Cleaning up local workspace..."
            
            # åˆ é™¤å…‹éš†çš„æºç ç›®å½•
            if [ -d "rustdesk-source" ]; then
              rm -rf rustdesk-source
              echo "âœ… Successfully cleaned up local source code directory"
            else
              echo "â„¹ï¸ Local source code directory not found"
            fi
            
            # æ¸…ç†å…¶ä»–å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
            find . -name "*.tmp" -delete 2>/dev/null || true
            find . -name "*.temp" -delete 2>/dev/null || true
            
            echo "âœ… Successfully reverted repository and cleaned up workspace"
            echo "revert_success=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤6: æœ€ç»ˆæ¸…ç†ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰
      - name: Final cleanup
        id: final-cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Final cleanup step..."
          
          # æ£€æŸ¥debugæ¨¡å¼
          if [ "$enable_debug" = "true" ]; then
            echo "ðŸ› Debugæ¨¡å¼å·²å¯ç”¨ï¼Œæ‰§è¡Œç®€åŒ–æ¸…ç†..."
            
            # ç¡®ä¿æ¸…ç†æœ¬åœ°æºç ç›®å½•
            if [ -d "rustdesk-source" ]; then
              rm -rf rustdesk-source
              echo "âœ… Cleaned up rustdesk-source directory"
            fi
            
            echo "âœ… Debugæ¨¡å¼ç®€åŒ–æ¸…ç†å®Œæˆ"
          else
            # ç¡®ä¿æ¸…ç†æœ¬åœ°æºç ç›®å½•
            if [ -d "rustdesk-source" ]; then
              rm -rf rustdesk-source
              echo "âœ… Cleaned up rustdesk-source directory"
            fi
            
            # æ¸…ç†å…¶ä»–ä¸´æ—¶æ–‡ä»¶
            find . -name "*.tmp" -delete 2>/dev/null || true
            find . -name "*.temp" -delete 2>/dev/null || true
            find . -name "*.log" -delete 2>/dev/null || true
            
            # æ¸…ç†Gité…ç½®
            git config --global --unset user.name 2>/dev/null || true
            git config --global --unset user.email 2>/dev/null || true
            
            echo "âœ… Full cleanup completed"
          fi
          
          echo "cleanup_completed=true" >> $GITHUB_OUTPUT

  # 05-å®Œæˆå¤„ç†
  finish:
    needs: [trigger, review, join-queue, wait-build-lock, build]
    if: always() && needs.trigger.result != 'skipped'
    runs-on: ubuntu-latest
    outputs:
      finish_status: ${{ steps.finish.outputs.finish_status }}
      notification_sent: ${{ steps.finish.outputs.notification_sent }}
      cleanup_completed: ${{ steps.finish.outputs.cleanup_completed }}
      lock_released: ${{ steps.finish.outputs.lock_released }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Complete cleanup and notification
        id: finish
        run: |
          source .github/workflows/scripts/finish.sh
          source .github/workflows/scripts/queue-manager.sh
          
          # é‡æ–°èŽ·å– github.event
          EVENT_DATA='${{ toJSON(github.event) }}'

          # ç¡®å®šæž„å»ºçŠ¶æ€
          if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.build.outputs.build_success }}" = "true" ]; then
            build_status="success"
            download_url="${{ needs.build.outputs.download_url || '' }}"
            error_message="${{ needs.build.outputs.error_message || '' }}"
          else
            build_status="failure"
            download_url=""
            error_message="æž„å»ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
          fi
          
          # è§£æžæž„å»ºæ•°æ®ï¼ˆä»ŽEVENT_DATAä¸­æå–ï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä»Žinputsä¸­æå–
            tag="${{ github.event.inputs.tag }}"
            customer="${{ github.event.inputs.customer }}"
            email="${{ github.event.inputs.email }}"
          else
            # Issueè§¦å‘ï¼šä»Žissueä¸­æå–
            tag=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'tag:[^[:space:]]*' | cut -d: -f2 || echo '')
            customer=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'customer:[^[:space:]]*' | cut -d: -f2 || echo '')
            email=$(echo "$EVENT_DATA" | jq -r '.issue.body // empty' | grep -o 'email:[^[:space:]]*' | cut -d: -f2 || echo '')
          fi
          
          build_id="${{ needs.trigger.outputs.build_id }}"
          
          # è®¾ç½®æž„å»ºå‚æ•°
          EMAIL="$email"
          TAG="$tag"
          CUSTOMER="$customer"
          
          # æ¸…ç†æž„å»ºçŽ¯å¢ƒ
          echo "Cleaning up build environment..."
          cleanup_completed="true"
          
          # é‡Šæ”¾æ‰€æœ‰é”
          echo "Releasing all locks..."
          if release_all_locks; then
            lock_released="success"
            echo "âœ… Successfully released all locks"
          else
            lock_released="failed"
            echo "âŒ Failed to release locks"
          fi
          
          # æ¸…ç†é˜Ÿåˆ—
          echo "Cleaning up queue..."
          cleanup_queue
          echo "âœ… Queue cleanup completed"
          
          # ç”Ÿæˆå®Œæˆé€šçŸ¥
          notification=$(generate_completion_notification "$build_status" "$tag" "$customer" "$download_url" "$error_message")
          
          # å‘é€é€šçŸ¥
          notification_sent="false"
          if [ -n "$EMAIL" ]; then
            echo "Sending notification to: $EMAIL"
            notification_sent="true"
          fi
          
          # è¾“å‡ºå®ŒæˆçŠ¶æ€
          echo "Build completed with status: $build_status"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "finish_status=$build_status" >> $GITHUB_OUTPUT
          echo "notification_sent=$notification_sent" >> $GITHUB_OUTPUT
          echo "cleanup_completed=$cleanup_completed" >> $GITHUB_OUTPUT
          echo "lock_released=$lock_released" >> $GITHUB_OUTPUT
          
 
